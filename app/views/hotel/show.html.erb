<script>
  function GetRoomAvailable() {
    var $bookingDetailId = $("#bookingDetailId");
    $bookingDetailId.html("");

    $.ajax({
      url: '/Hotel/_GetRoomAvailable',
      timeout: 20000,
      data: {
        hotelId: $("#HotelId").val(),
        checkInDate: $("#CheckInDate").val(),
        checkOutDate: $("#CheckOutDate").val()
      },
      beforeSend: function () {
        $(".divLoading").addClass("loading");
      },
      success: function (result) {
        $bookingDetailId.html(result);
        $(".divLoading").removeClass("loading");
      },
      error: function (message) {
        $(".divLoading").removeClass("loading");
      }
    });

    ViewRoomQuotation();
  }

  function SumAmount(idxHotelRoom) {
    //alert($(quantity).val());

    var tolRoomAmount = 0;
    var tolAmount = 0;

    if ($("#CheckInDate").val() == '' || $("#CheckOutDate").val() == '') {
      ShowNoti("Ngày nhận/trả phòng", "Vui lòng chọn ngày nhận phòng và ngày trả phòng", "error");
      return;
    }

    if ($("#CheckInDate").val() > $("#CheckOutDate").val()) {
      ShowNoti("Ngày nhận/trả phòng", "Ngày trả phòng phải sau ngày nhận phòng", "error");
      return;
    }

    if (idxHotelRoom >= 0) {
      $.ajax({
        url: '/Hotel/_GetRoomAvailableByRoomId',
        timeout: 20000,
        data: {
          roomId: $("#BookingRoom_" + idxHotelRoom + "_RoomId").val(),
          checkInDate: $("#CheckInDate").val(),
          checkOutDate: $("#CheckOutDate").val(),
          quantityRoomRequire: $("#BookingRoom_" + idxHotelRoom + "_QuantityRoomRequire").val(),
          quantityExtraBedRequire: $("#BookingRoom_" + idxHotelRoom + "_QuantityExtraBedRequire").val(),
          quantityChildRequire: $("#BookingRoom_" + idxHotelRoom + "_QuantityChildRequire").val()
        },
        //contentType: false, processData: false,
        beforeSend: function () {
          $(".divLoading").addClass("loading");
        },
        success: function (result) {
          $(".divLoading").removeClass("loading");

          if (result.status >= 1) {

            roomAmount = result.RoomAvailable.AmountRoom;
            roomAmountExtraBed = result.RoomAvailable.AmountExtraBed;
            roomAmountChild = result.RoomAvailable.AmountChild;

            //Amount Right
            document.getElementById("BookingRoom_" + idxHotelRoom + "_AmountRoomValue").value = roomAmount;
            document.getElementById("BookingRoom_" + idxHotelRoom + "_AmountRoom").value = formatnumber(roomAmount.toString());

            document.getElementById("BookingRoom_" + idxHotelRoom + "_AmountExtraBedValue").value = roomAmountExtraBed;
            document.getElementById("BookingRoom_" + idxHotelRoom + "_AmountExtraBed").value = formatnumber(roomAmountExtraBed.toString());

            document.getElementById("BookingRoom_" + idxHotelRoom + "_AmountChildValue").value = roomAmountChild;
            document.getElementById("BookingRoom_" + idxHotelRoom + "_AmountChild").value = formatnumber(roomAmountChild.toString());

            //Amount Left
            tolHotelRoom = Number($("#tolHotelRoom").val());
            if (tolHotelRoom > 0) {
              tolRoomAmount = 0;
              tolAmount = 0;
              for (i = 0; i < tolHotelRoom; i++) {
                tolRoomAmount += Number($("#BookingRoom_" + i + "_AmountRoomValue").val()) + Number($("#BookingRoom_" + i + "_AmountExtraBedValue").val()) + Number($("#BookingRoom_" + i + "_AmountChildValue").val());
              }
              tolAmount += tolRoomAmount;
              document.getElementById("totalRoomAmountValue").value = tolRoomAmount;
              document.getElementById("totalRoomAmountId").innerHTML = formatnumber(tolRoomAmount.toString());
              document.getElementById("totalAmountId").innerHTML = formatnumber(tolAmount.toString());
            }

            //ViewQuotationList();
          } else {
            //ShowNoti(result.title, result.text, "error");
            alert('Không lấy được tiền phòng');
          }
        },
        error: function (message) {
          $(".divLoading").removeClass("loading");
        }
      });
      //./Room amount

    }

    //Include Services Amount Right
    for (i = 0; i < 51; i++) {
      //tolAmount
      var amount = Number($("#BookingDetail_" + i + "_Quantity").val()) * Number($("#BookingDetail_" + i + "_Price").val());
      document.getElementById("Amount_" + i).value = amount.toString();
    }
    for (i = 0; i < 51; i++) {
      var amount_i = document.getElementById("Amount_" + i).value;
      if (amount_i > 0) {
        document.getElementById("Amount_" + i).value = formatnumber(amount_i.toString());
      }
    }

    //Amount Left
    tolAmount = Number($("#totalRoomAmountValue").val());
    for (j = 0; j <= 3; j++) { //VuLNS 03Jun20
      var serviceTypeAmount = 0;
      for (i = 0; i < 51; i++) {
        //ServiceTypeId_
        if ($("#ServiceTypeId_" + i).val() == $("#serviceTypeAmountIdValue_" + j).val()) {
          serviceTypeAmount += Number($("#BookingDetail_" + i + "_Quantity").val()) * Number($("#BookingDetail_" + i + "_Price").val());
        }

      }

      //Service type amount left
      if (serviceTypeAmount != null && serviceTypeAmount >= 0) {
        tolAmount += serviceTypeAmount;

        document.getElementById("serviceTypeAmountId_" + $("#serviceTypeAmountIdValue_" + j).val()).innerHTML = formatnumber(serviceTypeAmount.toString());
        document.getElementById("totalAmountId").innerHTML = formatnumber(tolAmount.toString());

      }
    }

  }

  function ViewQuotationList() {
    var $quotationListId = $("#quotationListId");
    $quotationListId.html("");

    form = $("#frmBooking");
    form.removeData('validator');
    form.removeData('unobtrusiveValidation');
    $.validator.unobtrusive.parse("#frmBooking");

    //if (form.valid()) {
    var formdata = new FormData(); //FormData object

    formdata.append("checkInDate", $("#CheckInDate").val());
    formdata.append("checkOutDate", $("#CheckOutDate").val());
    //Room
    var idxHotelRoom = Number($("#tolHotelRoom").val());
    if (idxHotelRoom > 0) {
      for (var i = 0; i < idxHotelRoom; i++) {
        if ($("#BookingRoom_" + i + "_QuantityRoomRequire").val() > 0) {
          formdata.append("BookingRoom[" + i + "].RoomId", $("#BookingRoom_" + i + "_RoomId").val());
          formdata.append("BookingRoom[" + i + "].QuantityRoomRequire", $("#BookingRoom_" + i + "_QuantityRoomRequire").val());
          formdata.append("BookingRoom[" + i + "].QuantityExtraBedRequire", $("#BookingRoom_" + i + "_QuantityExtraBedRequire").val());
          formdata.append("BookingRoom[" + i + "].QuantityChildRequire", $("#BookingRoom_" + i + "_QuantityChildRequire").val());
        }
      }
    }

    $.ajax({
      url: '/Hotel/_GetQuotation',
      type: "POST",
      timeout: 20000,
      data: formdata,
      contentType: false,
      processData: false,
      beforeSend: function () {
        $(".divLoading").addClass("loading");
      },
      success: function (result) {
        $quotationListId.html(result);
        $(".divLoading").removeClass("loading");
      },
      error: function (message) {
        $(".divLoading").removeClass("loading");
      }
    });
  }

  function ViewRoomQuotation() {
    var $quotationListId = $("#quotationListId");
    $quotationListId.html("");
    if ($("#HotelId").val() != '' && $("#CheckInDate").val() != '' && $("#CheckOutDate").val() != '') {
      $.ajax({
        url: '/Hotel/_GetRoomQuotation',
        timeout: 20000,
        data: {
          hotelId: $("#HotelId").val(),
          checkInDate: $("#CheckInDate").val(),
          checkOutDate: $("#CheckOutDate").val()
        },
        beforeSend: function () {
          $(".divLoading").addClass("loading");
        },
        success: function (result) {
          $quotationListId.html(result);
          $(".divLoading").removeClass("loading");
        },
        error: function (message) {
          $(".divLoading").removeClass("loading");
        }
      });
    }
  }

  function ViewMoreHotelDesc() {
    //alert(document.getElementById("viewMoreHotelDescId").innerHTML);
    if (document.getElementById("viewMoreHotelDescId").innerHTML == 'Xem thêm &gt;') {
      document.getElementById("hotelDesc").style.height = 'auto';
      document.getElementById("viewMoreHotelDescId").innerHTML = '&lt; Thu gọn';
    } else {
      document.getElementById("hotelDesc").style.height = '100px';
      document.getElementById("viewMoreHotelDescId").innerHTML = 'Xem thêm &gt;';
    }
  }

  //function ViewMoreRoomDesc()
  function ViewMoreRoomDesc(id) {
    //alert(document.getElementById("viewMoreRoomDescId").innerHTML);
    if (document.getElementById("viewMoreRoomDescId_" + id).innerHTML == 'Xem thêm &gt;') {
      document.getElementById("roomDesc_" + id).style.height = 'auto';
      document.getElementById("viewMoreRoomDescId_" + id).innerHTML = '&lt; Thu gọn';
    } else {
      document.getElementById("roomDesc_" + id).style.height = '100px';
      document.getElementById("viewMoreRoomDescId_" + id).innerHTML = 'Xem thêm &gt;';
    }
  }

  function formatnumber(what) {
    if (what != null) {
      var value = what;
      value = value.replace(',', '');
      value = value.replace(',', '');
      value = value.replace(',', '');
      var temp = '';
      var test = value.length;
      var count = 0;
      for (i = test - 1; i >= 0; i--) {
        count++
        temp = value.charAt(i) + temp;
        if (count % 3 == 0 && i > 0) {
          temp = ',' + temp;
        }
      }
      return temp;
    }
    return "";
  }
</script>
